---
/**
 * EventCard Component
 *
 * Reusable event card component for displaying events consistently across the site.
 * Supports featured events, registration links, and clickable locations.
 *
 * Usage:
 *   <EventCard event={event} />
 */

interface Props {
  event: {
    id: string;
    name: string;
    slug?: string;
    description?: string;
    startsAt: string;
    endsAt?: string;
    location?: string;
    allDay?: boolean;
    tags?: string[];
    featured?: boolean;
    imageUrl?: string;
    registrationUrl?: string;
  };
}

const { event } = Astro.props;

// Format time for display
function formatEventTime(dateStr: string, allDay: boolean): string {
  if (allDay) return 'TBD';
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    timeZone: 'America/Chicago'
  });
}

// Get display-friendly location name
function getEventLocation(location: string): string {
  if (!location || !location.trim()) return 'TBD';
  const parts = location.split(' - ');
  return parts[0].trim();
}

// Get URL for location (directions page or Google Maps)
function getLocationUrl(location: string): string {
  if (!location || !location.trim()) return '';
  const lowerLocation = location.toLowerCase();
  if (lowerLocation.includes('river of life') || lowerLocation.includes('425 university')) {
    return '/directions';
  }
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
}

// Check if location is external (not at church)
function isExternalLocation(location: string): boolean {
  if (!location || !location.trim()) return false;
  const lowerLocation = location.toLowerCase();
  return !lowerLocation.includes('river of life') && !lowerLocation.includes('425 university');
}

// Check if location has valid content
function hasValidLocation(location: string): boolean {
  return location && location.trim() !== '' && location.trim() !== 'TBD';
}

// Strip HTML tags from description
function stripHtml(html: string): string {
  return html.replace(/<[^>]*>/g, '');
}

// Parse date for display
const eventDate = new Date(event.startsAt);
const dayNum = eventDate.toLocaleDateString('en-US', { day: 'numeric', timeZone: 'America/Chicago' });
const dayName = eventDate.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'America/Chicago' });

// Determine card type
const isFeatured = event.featured;
const hasRegistration = !!event.registrationUrl;
const cleanDescription = event.description ? stripHtml(event.description).substring(0, 150) : '';
---

{isFeatured ? (
  <!-- Featured Event Card - links to detail page -->
  <a href={`/events/${event.slug}`} class="event-card featured">
    <div class="event-date-badge">
      <span class="event-day-num">{dayNum}</span>
      <span class="event-day-name">{dayName}</span>
    </div>
    <div class="event-details">
      <h3 class="event-name">
        <svg class="featured-star" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        {event.name}
      </h3>
      <div class="event-meta">
        <span class="event-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
          {formatEventTime(event.startsAt, event.allDay || false)}
        </span>
        {hasValidLocation(event.location || '') ? (
          <span
            class="event-location location-link"
            data-location-url={getLocationUrl(event.location || '')}
            data-external={isExternalLocation(event.location || '') ? "true" : "false"}
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </span>
        ) : (
          <span class="event-location">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </span>
        )}
      </div>
      {cleanDescription && (
        <p class="event-desc">{cleanDescription}{(event.description?.length || 0) > 150 ? '...' : ''}</p>
      )}
      <div class="event-links">
        <span class="event-link">View Details →</span>
        {hasRegistration && (
          <span
            class="event-link register-link"
            data-register-url={event.registrationUrl}
          >Register Now →</span>
        )}
      </div>
    </div>
  </a>
) : hasRegistration ? (
  <!-- Registration Event Card - links to registration -->
  <a href={event.registrationUrl} target="_blank" rel="noopener noreferrer" class="event-card has-registration">
    <div class="event-date-badge">
      <span class="event-day-num">{dayNum}</span>
      <span class="event-day-name">{dayName}</span>
    </div>
    <div class="event-details">
      <h3 class="event-name">{event.name}</h3>
      <div class="event-meta">
        <span class="event-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
          {formatEventTime(event.startsAt, event.allDay || false)}
        </span>
        {hasValidLocation(event.location || '') ? (
          <span
            class="event-location location-link"
            data-location-url={getLocationUrl(event.location || '')}
            data-external={isExternalLocation(event.location || '') ? "true" : "false"}
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </span>
        ) : (
          <span class="event-location">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </span>
        )}
      </div>
      {cleanDescription && (
        <p class="event-desc">{cleanDescription}{(event.description?.length || 0) > 150 ? '...' : ''}</p>
      )}
      <span class="event-link register-link">Register Now →</span>
    </div>
  </a>
) : (
  <!-- Standard Event Card - no link wrapper -->
  <div class="event-card">
    <div class="event-date-badge">
      <span class="event-day-num">{dayNum}</span>
      <span class="event-day-name">{dayName}</span>
    </div>
    <div class="event-details">
      <h3 class="event-name">{event.name}</h3>
      <div class="event-meta">
        <span class="event-time">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
          {formatEventTime(event.startsAt, event.allDay || false)}
        </span>
        {hasValidLocation(event.location || '') ? (
          <a
            href={getLocationUrl(event.location || '')}
            class="event-location location-link"
            target={isExternalLocation(event.location || '') ? "_blank" : undefined}
            rel={isExternalLocation(event.location || '') ? "noopener noreferrer" : undefined}
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </a>
        ) : (
          <span class="event-location">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            {getEventLocation(event.location || '')}
          </span>
        )}
      </div>
      {cleanDescription && (
        <p class="event-desc">{cleanDescription}{(event.description?.length || 0) > 150 ? '...' : ''}</p>
      )}
    </div>
  </div>
)}
