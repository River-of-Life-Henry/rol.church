---
import Base from '../layouts/Base.astro';
import PageHero from '../components/PageHero.astro';

// Load YouTube data from sync (fallback video ID if sync hasn't run)
let youtubeData;
try {
  youtubeData = await import('../data/youtube.json');
} catch (e) {
  youtubeData = null;
}

const channelId = youtubeData?.channel_id || 'UCh7sGdfticWqBCIFSqhZcwQ';
const latestVideoId = youtubeData?.latest_video?.id || '';
---

<Base title="Watch Live" description="Join River of Life for live worship services. Watch our live stream or catch up on recent messages.">
  <PageHero title="Watch Live" image="/hero/2.jpg" />

  <!-- Countdown Banner (hidden by default, shown by JS when applicable) -->
  <div id="countdown-banner" class="countdown-banner" style="display: none;">
    <div class="countdown-content">
      <span class="countdown-label">Next Service Starts In:</span>
      <span id="countdown-timer" class="countdown-timer"></span>
    </div>
  </div>

  <!-- Live Indicator (hidden by default, shown when live) -->
  <div id="live-indicator" class="live-indicator" style="display: none;">
    <span class="live-dot"></span>
    <span class="live-text">LIVE NOW</span>
  </div>

  <!-- Theater Mode Video Section -->
  <section class="theater-section">
    <div class="video-wrapper">
      <iframe
        id="youtube-player"
        src={latestVideoId ? `https://www.youtube.com/embed/${latestVideoId}?rel=0&modestbranding=1&iv_load_policy=3&color=white` : `https://www.youtube.com/embed/live_stream?channel=${channelId}&modestbranding=1&rel=0`}
        title="River of Life Live Stream"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
        data-channel-id={channelId}
        data-latest-video-id={latestVideoId}
      ></iframe>
    </div>
    <div class="watch-options">
      <a href="https://www.youtube.com/@rol-henry/live" target="_blank" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.707 3.42-.149 5.677.021 12c-.17 6.323.684 8.579 4.364 8.816 3.599.245 11.626.246 15.23 0C23.293 20.58 24.149 18.323 23.979 12c.17-6.323-.684-8.579-4.364-8.816zM9 16V8l8 4-8 4z"/></svg>
        Watch Live on YouTube
      </a>
      <a href="https://www.youtube.com/@rol-henry/videos" target="_blank" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"/></svg>
        View Past Services
      </a>
    </div>
  </section>

  <section class="live-content">
    <div class="container">
      <div class="info-grid">
        <div class="info-card">
          <h3>Live Stream Schedule</h3>
          <p><strong>Sunday</strong></p>
          <p>10:00 AM - 12:30 PM</p>
          <p><strong>Wednesday</strong></p>
          <p>7:00 - 8:00 PM</p>
        </div>

        <div class="info-card">
          <h3>Can't Watch Live?</h3>
          <p>All our services are recorded and available on our YouTube channel. Watch anytime!</p>
        </div>
      </div>

      <div class="phonelive-section">
        <div class="phonelive-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
          <h2>PhoneLive</h2>
          <p class="subtitle">Listen to church on the phone</p>
        </div>

        <div class="phone-number">
          <a href="tel:+13093643165">(309) 364-3165</a>
        </div>

        <div class="phonelive-features">
          <div class="feature">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            </div>
            <h4>Listen Live</h4>
            <p>Call during service to listen live on your phone</p>
          </div>

          <div class="feature">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1zM12 3v10l3-3h6V3h-9z"/></svg>
            </div>
            <h4>Get a Call</h4>
            <p>Receive a call when service starts so you never miss it</p>
          </div>

          <div class="feature">
            <div class="feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
            </div>
            <h4>Recent Service</h4>
            <p>Listen to the most recent service anytime you call</p>
          </div>
        </div>

        <p class="phonelive-note">Perfect for those without internet access or who prefer to listen by phone.</p>
      </div>
    </div>
  </section>
</Base>

<script>
  // Service schedule in Chicago timezone (Central Time)
  const SERVICES = [
    { day: 0, startHour: 10, startMinute: 0, endHour: 12, endMinute: 30 }, // Sunday
    { day: 3, startHour: 19, startMinute: 0, endHour: 20, endMinute: 0 }   // Wednesday
  ];

  // Check interval in milliseconds (5 minutes)
  const CHECK_INTERVAL = 5 * 60 * 1000;

  // State
  let isLive = false;
  let lastCheckTime = 0;

  // Update live state UI
  function setLiveState(live) {
    isLive = live;
    const liveIndicator = document.getElementById('live-indicator');
    const countdownBanner = document.getElementById('countdown-banner');

    if (liveIndicator) {
      liveIndicator.style.display = live ? 'flex' : 'none';
    }

    if (countdownBanner && live) {
      countdownBanner.style.display = 'none';
    }
  }

  // Get current time in Chicago timezone
  function getChicagoTime() {
    return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  }

  // Check if we're currently within service hours
  function isDuringService() {
    const now = getChicagoTime();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const currentMinutes = hour * 60 + minute;

    for (const service of SERVICES) {
      if (day === service.day) {
        const startMinutes = service.startHour * 60 + service.startMinute;
        const endMinutes = service.endHour * 60 + service.endMinute;
        if (currentMinutes >= startMinutes && currentMinutes <= endMinutes) {
          return true;
        }
      }
    }
    return false;
  }

  // Get the next scheduled service time
  function getNextService() {
    const now = getChicagoTime();
    const currentDay = now.getDay();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    let nextService = null;
    let minDaysAway = 8;

    for (const service of SERVICES) {
      let daysUntil = service.day - currentDay;
      const serviceStartMinutes = service.startHour * 60 + service.startMinute;

      if (daysUntil === 0 && currentMinutes >= serviceStartMinutes) {
        daysUntil = 7;
      } else if (daysUntil < 0) {
        daysUntil += 7;
      }

      if (daysUntil < minDaysAway) {
        minDaysAway = daysUntil;
        nextService = { ...service, daysUntil };
      }
    }

    if (nextService) {
      const serviceDate = new Date(now);
      serviceDate.setDate(serviceDate.getDate() + nextService.daysUntil);
      serviceDate.setHours(nextService.startHour, nextService.startMinute, 0, 0);
      return serviceDate;
    }

    return null;
  }

  // Format countdown timer
  function formatCountdown(ms) {
    if (ms <= 0) return null;

    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    const parts = [];
    if (days > 0) parts.push(`${days}d`);
    if (hours % 24 > 0) parts.push(`${hours % 24}h`);
    if (minutes % 60 > 0) parts.push(`${minutes % 60}m`);
    if (seconds % 60 >= 0 && parts.length < 3) parts.push(`${seconds % 60}s`);

    return parts.join(' ');
  }

  // Update the countdown display
  function updateCountdown() {
    const banner = document.getElementById('countdown-banner');
    const timer = document.getElementById('countdown-timer');

    if (!banner || !timer) return;

    // Don't show countdown if live or during service
    if (isLive || isDuringService()) {
      banner.style.display = 'none';
      return;
    }

    const nextService = getNextService();
    if (!nextService) {
      banner.style.display = 'none';
      return;
    }

    const now = getChicagoTime();
    const diff = nextService.getTime() - now.getTime();

    if (diff <= 0) {
      banner.style.display = 'none';
      // Service should be starting, refresh to check for live
      refreshLiveCheck();
      return;
    }

    // Only show countdown if within 24 hours
    if (diff <= 24 * 60 * 60 * 1000) {
      timer.textContent = formatCountdown(diff);
      banner.style.display = 'flex';
    } else {
      banner.style.display = 'none';
    }
  }

  // Switch between live stream and recent video
  function updateVideoEmbed() {
    const player = document.getElementById('youtube-player');
    if (!player) return;

    const channelId = player.dataset.channelId;
    const latestVideoId = player.dataset.latestVideoId;
    const duringService = isDuringService();

    if (duringService) {
      // During service, show live stream
      const liveUrl = `https://www.youtube.com/embed/live_stream?channel=${channelId}&autoplay=1&modestbranding=1&rel=0&iv_load_policy=3&color=white`;
      if (!player.src.includes('live_stream')) {
        player.src = liveUrl;
      }
      setLiveState(true);
    } else {
      // Outside service, show latest video
      if (latestVideoId) {
        const videoUrl = `https://www.youtube.com/embed/${latestVideoId}?rel=0&modestbranding=1&iv_load_policy=3&color=white`;
        if (!player.src.includes(latestVideoId)) {
          player.src = videoUrl;
        }
      }
      setLiveState(false);
    }
  }

  // Refresh the live stream check
  function refreshLiveCheck() {
    const now = Date.now();
    if (now - lastCheckTime < 30000) return; // Don't check more than once per 30 seconds
    lastCheckTime = now;

    updateVideoEmbed();
  }

  // Initialize
  function init() {
    // Initial state check
    updateVideoEmbed();
    updateCountdown();

    // Update countdown every second
    setInterval(updateCountdown, 1000);

    // Check for live stream every 5 minutes
    setInterval(refreshLiveCheck, CHECK_INTERVAL);

    // Also check on visibility change (when user returns to tab)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        refreshLiveCheck();
        updateCountdown();
      }
    });
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  /* Countdown Banner */
  .countdown-banner {
    background: linear-gradient(135deg, var(--color-teal), var(--color-teal-dark));
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
  }

  .countdown-content {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .countdown-label {
    font-weight: 500;
  }

  .countdown-timer {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: var(--font-mono, monospace);
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 0.375rem;
  }

  /* Live Indicator */
  .live-indicator {
    background: var(--color-navy);
    color: white;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
  }

  .live-dot {
    width: 12px;
    height: 12px;
    background: #ff0000;
    border-radius: 50%;
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.1); }
  }

  .live-text {
    font-weight: 700;
    letter-spacing: 0.05em;
    color: #ff0000;
  }

  /* Theater Mode Video Section */
  .theater-section {
    background: #0f0f0f;
    padding: 0 0 2rem 0;
  }

  .theater-section .video-wrapper {
    position: relative;
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding-bottom: min(56.25%, 80vh);
    height: 0;
    overflow: hidden;
    background: #000;
  }

  .theater-section .video-wrapper iframe,
  .theater-section .video-wrapper #youtube-player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .theater-section .watch-options {
    display: flex;
    gap: 1rem;
    justify-content: center;
    padding: 1.5rem 2rem 0;
    flex-wrap: wrap;
  }

  .no-video-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    text-align: center;
    padding: 2rem;
  }

  .no-video-message a {
    color: var(--color-gold);
  }

  /* Live Content */
  .live-content {
    padding: 4rem 2rem;
  }

  .live-content .container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .btn-primary {
    background: var(--color-teal);
    color: white !important;
    padding: 0.875rem 2rem;
    border-radius: 0.375rem;
    font-weight: 600;
  }

  .btn-primary:hover {
    background: var(--color-teal-dark);
  }

  .btn-secondary {
    background: var(--color-bg-alt);
    color: var(--color-navy) !important;
    padding: 0.875rem 2rem;
    border-radius: 0.375rem;
    font-weight: 600;
  }

  .btn-secondary:hover {
    background: var(--color-navy);
    color: white !important;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
  }

  .info-card {
    background: var(--color-bg-alt);
    padding: 2rem;
    border-radius: 0.5rem;
    text-align: center;
  }

  .info-card h3 {
    color: var(--color-navy);
    margin-bottom: 1rem;
  }

  .info-card p {
    color: var(--color-text);
    margin-bottom: 0.25rem;
  }

  /* PhoneLive Section */
  .phonelive-section {
    margin-top: 4rem;
    background: var(--color-navy);
    border-radius: 1rem;
    padding: 3rem 2rem;
    text-align: center;
    color: white;
  }

  .phonelive-header {
    margin-bottom: 1.5rem;
  }

  .phonelive-header svg {
    color: var(--color-gold);
    margin-bottom: 0.5rem;
  }

  .phonelive-header h2 {
    font-size: 2rem;
    margin-bottom: 0.25rem;
  }

  .phonelive-header .subtitle {
    color: rgba(255,255,255,0.8);
    font-family: var(--font-script);
    font-size: 1.4rem;
  }

  .phone-number {
    margin: 2rem 0;
  }

  .phone-number a {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-gold) !important;
    text-decoration: none;
    transition: color 0.2s;
  }

  .phone-number a:hover {
    color: white !important;
  }

  .phonelive-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
  }

  .feature {
    padding: 1rem;
  }

  .feature-icon {
    color: var(--color-teal);
    margin-bottom: 0.75rem;
  }

  .feature h4 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: white;
  }

  .feature p {
    color: rgba(255,255,255,0.8);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .phonelive-note {
    color: rgba(255,255,255,0.7);
    font-size: 0.9rem;
    font-style: italic;
    margin-top: 1rem;
  }

  @media (max-width: 768px) {
    .theater-section .watch-options {
      flex-direction: column;
      align-items: center;
    }

    .phone-number a {
      font-size: 1.75rem;
    }

    .phonelive-section {
      padding: 2rem 1.5rem;
    }

    .countdown-timer {
      font-size: 1.25rem;
    }
  }
</style>
