name: Deploy Webhooks Lambda

on:
  push:
    branches:
      - main
    paths:
      - 'webhooks/**'
      - '.github/workflows/deploy-webhooks.yml'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to deploy (dev or prod)'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install Serverless Framework
        run: |
          npm install -g serverless@3
          npm install -g serverless-domain-manager

      - name: Generate or use PCO webhook secret
        id: pco-secret
        env:
          GH_TOKEN: ${{ secrets.WEBHOOKS_GITHUB_PAT || github.token }}
          EXISTING_SECRET: ${{ secrets.PCO_WEBHOOK_SECRET }}
          HAS_PAT: ${{ secrets.WEBHOOKS_GITHUB_PAT != '' }}
        run: |
          if [ -n "$EXISTING_SECRET" ]; then
            echo "✓ PCO_WEBHOOK_SECRET already exists"
            echo "secret=$EXISTING_SECRET" >> $GITHUB_OUTPUT
          else
            echo "PCO_WEBHOOK_SECRET not set, generating new secret..."
            NEW_SECRET=$(openssl rand -hex 32)
            echo "::add-mask::$NEW_SECRET"
            echo "secret=$NEW_SECRET" >> $GITHUB_OUTPUT

            if [ "$HAS_PAT" = "true" ]; then
              gh secret set PCO_WEBHOOK_SECRET --body "$NEW_SECRET"
              echo "✓ Created PCO_WEBHOOK_SECRET in GitHub secrets"
            else
              echo "⚠️  WEBHOOKS_GITHUB_PAT not set - cannot save secret to GitHub"
              echo "Please add PCO_WEBHOOK_SECRET manually:"
              echo "  Value: $NEW_SECRET"
              echo "  URL: https://github.com/River-of-Life-Henry/rol.church/settings/secrets/actions"
            fi
          fi

      - name: Deploy to AWS
        id: deploy
        working-directory: webhooks
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_ROL }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_ROL }}
          GITHUB_PAT: ${{ secrets.WEBHOOKS_GITHUB_PAT }}
          GITHUB_REPO: River-of-Life-Henry/rol.church
          PCO_WEBHOOK_SECRET: ${{ steps.pco-secret.outputs.secret }}
          CLOUDFLARE_WEBHOOK_SECRET: ${{ secrets.CLOUDFLARE_WEBHOOK_SECRET }}
        run: |
          STAGE="${{ inputs.stage || 'prod' }}"
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "Deploying to stage: $STAGE"

          # Create custom domain if it doesn't exist (first-time setup)
          echo "Checking/creating custom domain..."
          sls create_domain --stage $STAGE || echo "Domain may already exist or need manual setup"

          # Deploy the Lambda and API Gateway
          sls deploy --stage $STAGE --verbose

      - name: Verify and setup webhooks
        id: verify-webhooks
        working-directory: webhooks
        env:
          ROL_PLANNING_CENTER_CLIENT_ID: ${{ secrets.ROL_PLANNING_CENTER_CLIENT_ID }}
          ROL_PLANNING_CENTER_SECRET: ${{ secrets.ROL_PLANNING_CENTER_SECRET }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          GH_TOKEN: ${{ secrets.WEBHOOKS_GITHUB_PAT || github.token }}
          HAS_PAT: ${{ secrets.WEBHOOKS_GITHUB_PAT != '' }}
        run: |
          STAGE="${{ steps.deploy.outputs.stage }}"
          echo "Verifying webhooks for stage: $STAGE"

          # Run the verification script and capture output
          ruby scripts/verify_and_setup_webhooks.rb --stage $STAGE | tee /tmp/webhook_output.txt

          # Check if a new Cloudflare secret was generated
          if grep -q "CLOUDFLARE_WEBHOOK_SECRET=" /tmp/webhook_output.txt; then
            CF_SECRET=$(grep "CLOUDFLARE_WEBHOOK_SECRET=" /tmp/webhook_output.txt | cut -d'=' -f2)
            if [ -n "$CF_SECRET" ]; then
              echo "::add-mask::$CF_SECRET"
              echo "cf_secret=$CF_SECRET" >> $GITHUB_OUTPUT
              echo "cf_secret_updated=true" >> $GITHUB_OUTPUT

              if [ "$HAS_PAT" = "true" ]; then
                echo "Saving Cloudflare webhook secret to GitHub secrets..."
                gh secret set CLOUDFLARE_WEBHOOK_SECRET --body "$CF_SECRET"
                echo "✓ Saved CLOUDFLARE_WEBHOOK_SECRET to GitHub secrets"
              else
                echo "⚠️  WEBHOOKS_GITHUB_PAT not set - cannot save secret to GitHub"
                echo "Please add CLOUDFLARE_WEBHOOK_SECRET manually"
              fi
            fi
          fi

      - name: Redeploy Lambda with Cloudflare secret (if updated)
        if: steps.verify-webhooks.outputs.cf_secret_updated == 'true'
        working-directory: webhooks
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_ROL }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_ROL }}
          GITHUB_PAT: ${{ secrets.WEBHOOKS_GITHUB_PAT }}
          GITHUB_REPO: River-of-Life-Henry/rol.church
          PCO_WEBHOOK_SECRET: ${{ steps.pco-secret.outputs.secret }}
          # Use the captured secret since secrets context won't have the new value yet
          CLOUDFLARE_WEBHOOK_SECRET: ${{ steps.verify-webhooks.outputs.cf_secret }}
        run: |
          STAGE="${{ steps.deploy.outputs.stage }}"
          echo "Redeploying to update Cloudflare webhook secret..."
          sls deploy --stage $STAGE
